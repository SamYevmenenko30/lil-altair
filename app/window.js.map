{"version":3,"file":"window.js","sources":["app/window.ts"],"sourceRoot":"/","sourcesContent":["import { BrowserWindow, app, ipcMain, protocol, session } from 'electron';\nimport path from 'path';\nimport url from 'url';\nimport { promises as fs } from 'fs';\nimport mime from 'mime-types';\nimport windowStateKeeper from 'electron-window-state';\n\nimport {\n  RenderOptions,\n  getDistDirectory,\n  renderAltair,\n  renderInitSnippet,\n} from 'altair-static';\n\nimport { checkMultipleDataVersions } from '../utils/check-multi-data-versions';\nimport { createSha256CspHash } from '../utils/csp-hash';\nimport { initMainProcessStoreEvents } from '../electron-store-adapter/main-store-events';\nimport {\n  initSettingsStoreEvents,\n  initUpdateAvailableEvent,\n} from '../settings/main/events';\n\nimport { MenuManager } from './menu';\nimport { ActionManager } from './actions';\nimport { TouchbarManager } from './touchbar';\nimport { handleWithCustomErrors } from '../utils/index';\nimport { AuthServer } from '../auth/server/index';\nimport { getAutobackup, setAutobackup } from '../utils/backup';\nimport {\n  IPC_EVENT_NAMES,\n  ELECTRON_ALLOWED_FORBIDDEN_HEADERS,\n  ALTAIR_CUSTOM_PROTOCOL,\n  SETTINGS_STORE_EVENTS,\n  InteropAppState,\n  ALTAIR_WINDOW_ID_HEADER,\n} from '@altairgraphql/electron-interop';\nimport validateAppSettings from 'altair-graphql-core/build/typegen/validate-settings';\nimport { error, log } from '../utils/log';\nimport { ElectronApp } from './index';\nimport {\n  getAltairSettingsFromFile,\n  getPersisedSettingsFromFile,\n  updateAltairSettingsOnFile,\n} from '../settings/main/store';\nimport { cspAsString } from '../utils/csp';\nimport { SENTRY_CSP_REPORT_URI } from '../constants';\nimport { InteropStateManager } from '../interop-state-manager';\n\nexport class WindowManager {\n  private instance?: BrowserWindow;\n\n  mainWindowState?: windowStateKeeper.State;\n\n  actionManager?: ActionManager;\n\n  menuManager?: MenuManager;\n\n  touchbarManager?: TouchbarManager;\n\n  interopStateManager?: InteropStateManager;\n\n  private ipcEventsInitialized = false;\n  private sessionEventsInitialized = false;\n\n  private rendererReady = new Promise((resolve) => {\n    ipcMain.once(IPC_EVENT_NAMES.RENDERER_READY, () => {\n      resolve(true);\n    });\n  });\n\n  constructor(private electronApp: ElectronApp) {}\n\n  getInstance() {\n    return this.instance;\n  }\n\n  async createWindow() {\n    await app.whenReady();\n    this.registerProtocol();\n\n    // Load the previous state with fallback to defaults\n    this.mainWindowState = windowStateKeeper({\n      defaultWidth: 1280,\n      defaultHeight: 800,\n    });\n\n    // Create the browser window.\n    this.instance = new BrowserWindow({\n      show: false, // show when ready\n      x: this.mainWindowState.x,\n      y: this.mainWindowState.y,\n      width: this.mainWindowState.width,\n      height: this.mainWindowState.height,\n      webPreferences: {\n        /**\n         * Disables the same-origin policy.\n         * Altair would be used to make requests to different endpoints, as a developer tool.\n         * Other security measures are put in place, such as CSP to ensure the app content is secure.\n         */\n        webSecurity: false,\n        allowRunningInsecureContent: false,\n        nodeIntegration: false,\n        nodeIntegrationInWorker: false,\n        contextIsolation: true,\n        // enableRemoteModule: process.env.NODE_ENV === \"test\", // remote required for spectron tests to work\n        preload: require.resolve('@altairgraphql/electron-interop/build/preload.js'), // path.join(__dirname, '../preload', 'index.js'),\n        sandbox: false,\n      },\n      // titleBarStyle: 'hidden-inset'\n    });\n\n    // Let us register listeners on the window, so we can update the state\n    // automatically (the listeners will be removed when the window is closed)\n    // and restore the maximized or full screen state\n    this.mainWindowState.manage(this.instance);\n\n    this.interopStateManager = new InteropStateManager();\n\n    // Populate the application menu\n    this.actionManager = new ActionManager(this);\n    this.menuManager = new MenuManager(this.actionManager);\n    // Set the touchbar\n    this.touchbarManager = new TouchbarManager(\n      this.actionManager,\n      this.interopStateManager\n    );\n    this.instance.setTouchBar(this.touchbarManager.createTouchBar());\n\n    // and load the index.html of the app.\n    this.instance.loadURL(\n      url.format({\n        pathname: '-',\n        protocol: `${ALTAIR_CUSTOM_PROTOCOL}:`,\n        slashes: true,\n      })\n    );\n\n    this.manageEvents();\n  }\n\n  sendMessage(channel: string, ...args: unknown[]) {\n    // Listen for the renderer ready event,\n    // then perform any pending actions\n    this.rendererReady.then(() => {\n      const instance = this.getInstance();\n\n      if (instance) {\n        instance.webContents.send(channel, ...args);\n      }\n    });\n  }\n\n  private manageEvents() {\n    initMainProcessStoreEvents();\n    initSettingsStoreEvents();\n    this.initInstanceEvents();\n    this.initSessionEvents();\n    this.initIpcEvents();\n  }\n\n  private initIpcEvents() {\n    // ipcMain events should only be initialized once\n    if (this.ipcEventsInitialized) {\n      return;\n    }\n    this.ipcEventsInitialized = true;\n\n    ipcMain.on(IPC_EVENT_NAMES.RENDERER_RESTART_APP, () => {\n      app.relaunch();\n      app.exit();\n    });\n\n    ipcMain.handle('reload-window', (e) => {\n      e.sender.reload();\n    });\n\n    ipcMain.on(IPC_EVENT_NAMES.RENDERER_SAVE_AUTOBACKUP_DATA, (e, data: string) => {\n      setAutobackup(data);\n    });\n\n    ipcMain.on(\n      IPC_EVENT_NAMES.RENDERER_SET_INTEROP_APP_STATE,\n      (e, interopAppState: InteropAppState) => {\n        this.interopStateManager?.setState(interopAppState);\n      }\n    );\n\n    handleWithCustomErrors(IPC_EVENT_NAMES.RENDERER_GET_AUTH_TOKEN, async (e) => {\n      if (!e.sender || e.sender !== this.instance?.webContents) {\n        throw new Error('untrusted source trying to get auth token');\n      }\n\n      const authServer = new AuthServer();\n      return authServer.getCustomToken();\n    });\n\n    handleWithCustomErrors(\n      IPC_EVENT_NAMES.RENDERER_GET_AUTOBACKUP_DATA,\n      async (e) => {\n        if (!e.sender || e.sender !== this.instance?.webContents) {\n          throw new Error('untrusted source');\n        }\n\n        return getAutobackup();\n      }\n    );\n\n    handleWithCustomErrors(\n      SETTINGS_STORE_EVENTS.GET_ALTAIR_APP_SETTINGS,\n      async (e) => {\n        if (!e.sender || e.sender !== this.instance?.webContents) {\n          throw new Error('untrusted source');\n        }\n\n        return getAltairSettingsFromFile();\n      }\n    );\n\n    handleWithCustomErrors(\n      SETTINGS_STORE_EVENTS.SET_ALTAIR_APP_SETTINGS,\n      async (e, data) => {\n        if (!e.sender || e.sender !== this.instance?.webContents) {\n          throw new Error('untrusted source');\n        }\n\n        // Validate data is a SettingsState\n        if (validateAppSettings(data)) {\n          return updateAltairSettingsOnFile(data);\n        }\n        error('Invalid settings data, not saving to file', data);\n      }\n    );\n  }\n\n  private initSessionEvents() {\n    // session events should only be initialized once\n    if (this.sessionEventsInitialized) {\n      return;\n    }\n    this.sessionEventsInitialized = true;\n\n    if (process.env.NODE_ENV /* === 'test'*/) {\n      session.defaultSession.webRequest.onBeforeRequest((details, callback) => {\n        log('Before request:', details);\n        if (details.uploadData) {\n          details.uploadData.forEach((uploadData) => {\n            log('Data sent:', uploadData.bytes.toString());\n          });\n        }\n        callback({\n          cancel: false,\n        });\n      });\n    }\n    session.defaultSession.webRequest.onBeforeSendHeaders((details, callback) => {\n      // Set defaults\n      details.requestHeaders.Origin = 'electron://altair';\n\n      // log(this.requestHeaders);\n      log('sending headers', details.requestHeaders);\n      // Set the request headers\n      const windowId =\n        details.requestHeaders[ALTAIR_WINDOW_ID_HEADER] ??\n        this.interopStateManager?.getState().activeWindowId;\n      const headers = windowId\n        ? this.interopStateManager?.getWindowState(windowId)?.headers ?? []\n        : [];\n      // Remove the altair window id header before sending the request\n      delete details.requestHeaders[ALTAIR_WINDOW_ID_HEADER];\n      headers.forEach((header) => {\n        if (\n          ELECTRON_ALLOWED_FORBIDDEN_HEADERS.includes(header.key.toLowerCase()) &&\n          header.enabled &&\n          header.key &&\n          header.value\n        ) {\n          details.requestHeaders[header.key] = header.value;\n        }\n      });\n      log('Final request headers', details.requestHeaders);\n      callback({\n        cancel: false,\n        requestHeaders: details.requestHeaders,\n      });\n    });\n\n    if (process.env.NODE_ENV /* === 'test'*/) {\n      session.defaultSession.webRequest.onSendHeaders((details) => {\n        if (details.requestHeaders) {\n          Object.keys(details.requestHeaders).forEach((headerKey) => {\n            log('Header sent:', headerKey, details.requestHeaders[headerKey]);\n          });\n        }\n      });\n    }\n\n    session.defaultSession.webRequest.onHeadersReceived((details, callback) => {\n      try {\n        const u = new url.URL(details.url);\n        // we only want to set the CSP for the altair custom protocol\n        if (u.protocol !== ALTAIR_CUSTOM_PROTOCOL + ':') {\n          return callback({ responseHeaders: details.responseHeaders });\n        }\n\n        // Allow iframe-sandbox to load without CSP\n        if (u.pathname.includes('/iframe-sandbox')) {\n          return callback({ responseHeaders: details.responseHeaders });\n        }\n      } catch {\n        // Do nothing\n      }\n\n      if (['mainFrame', 'subFrame'].includes(details.resourceType)) {\n        // Set the CSP\n        const initialSnippet = renderInitSnippet(this.getRenderOptions());\n        const scriptSrc = [\n          `'self'`,\n          `'sha256-1Sj1x3xsk3UVwnakQHbO0yQ3Xm904avQIfGThrdrjcc='`,\n          `'${createSha256CspHash(initialSnippet)}'`,\n          `https://cdn.jsdelivr.net`,\n          `localhost:*`,\n          `file:`,\n        ];\n\n        const additionalHeaders = {\n          // TODO: Figure out why an error from this breaks devtools\n          'Content-Security-Policy': [\n            cspAsString({\n              'script-src': scriptSrc,\n              'object-src': [\"'self'\"],\n              'report-uri': [SENTRY_CSP_REPORT_URI],\n              'report-to': ['csp-endpoint'],\n            }),\n          ],\n          'Report-To': JSON.stringify({\n            group: 'csp-endpoint',\n            max_age: 10886400, // 3 months\n            endpoints: [\n              {\n                url: SENTRY_CSP_REPORT_URI,\n              },\n            ],\n            include_subdomains: true,\n          }),\n          'Reporting-Endpoints': `csp-endpoint=\"${SENTRY_CSP_REPORT_URI}\"`,\n        };\n\n        return callback({\n          responseHeaders: {\n            ...details.responseHeaders,\n            ...additionalHeaders, // Additional headers\n          },\n        });\n      }\n\n      callback({ responseHeaders: details.responseHeaders });\n    });\n  }\n\n  private initInstanceEvents() {\n    if (!this.instance) {\n      throw new Error(\n        'Instance must be initialized before attempting to manage events'\n      );\n    }\n\n    initUpdateAvailableEvent(this.instance.webContents);\n    // Prevent the app from navigating away from the app\n    this.instance.webContents.on('will-navigate', (e) => e.preventDefault());\n\n    // Emitted when the window is closed.\n    this.instance.on('closed', () => {\n      // Dereference the window object, usually you would store windows\n      // in an array if your app supports multi windows, this is the time\n      // when you should delete the corresponding element.\n      this.instance = undefined;\n    });\n\n    this.instance.on('ready-to-show', () => {\n      if (!this.instance) {\n        throw new Error('instance not created!');\n      }\n      this.instance.show();\n      this.instance.focus();\n      checkMultipleDataVersions(this.instance);\n    });\n\n    this.instance.webContents.on('render-process-gone', (e, details) => {\n      error('render process gone', details);\n    });\n  }\n\n  private registerProtocol() {\n    if (protocol.isProtocolHandled(ALTAIR_CUSTOM_PROTOCOL)) {\n      return;\n    }\n    /**\n     * Using a custom buffer protocol, instead of a file protocol because of restrictions with the file protocol.\n     */\n    protocol.handle(ALTAIR_CUSTOM_PROTOCOL, async (request) => {\n      const requestDirectory = getDistDirectory();\n      const originalFilePath = path.join(\n        requestDirectory,\n        new url.URL(request.url).pathname\n      );\n      const indexPath = path.join(requestDirectory, 'index.html');\n      log('index path', indexPath);\n\n      const { mimeType, data } = await this.getFileContentData(\n        originalFilePath,\n        indexPath\n      );\n      return new Response(\n        new Blob([new Uint8Array(data)]), // Convert Buffer to Uint8Array for Blob\n        { headers: { 'content-type': mimeType } }\n      );\n    });\n  }\n\n  private async getFilePath(filePath: string): Promise<string> {\n    log('file..', filePath);\n\n    if (!filePath) {\n      return '';\n    }\n\n    if (filePath.endsWith('.map')) {\n      return filePath;\n    }\n    const stats = await fs.stat(filePath);\n    if (stats.isFile()) {\n      return filePath;\n    }\n\n    if (stats.isDirectory()) {\n      return this.getFilePath(path.join(filePath, 'index.html'));\n    }\n\n    return '';\n  }\n\n  /**\n   * @param {string} originalFilePath path to file\n   * @param {string} fallbackPath usually path to index file\n   */\n  private async getFileContentData(originalFilePath: string, fallbackPath: string) {\n    let filePath = await this.getFilePath(originalFilePath);\n\n    if (!filePath) {\n      filePath = fallbackPath;\n    }\n    if (filePath?.endsWith('.map')) {\n      return {\n        mimeType: 'text/plain',\n        data: Buffer.from(\n          '{\"version\": 3, \"file\": \"index.module.js\", \"sources\": [], \"sourcesContent\": [], \"names\": [], \"mappings\":\"\"}'\n        ),\n      };\n    }\n\n    // some files are binary files, eg. font, so don't encode utf8\n    let data = await fs.readFile(filePath);\n\n    if (filePath === fallbackPath) {\n      data = Buffer.from(renderAltair(this.getRenderOptions()), 'utf-8');\n    }\n\n    // Load the data from the file into a buffer and pass it to the callback\n    // Using the mime package to get the mime type for the file, based on the file name\n    return {\n      mimeType: mime.lookup(filePath) || '',\n      data,\n    };\n  }\n\n  private getRenderOptions(): RenderOptions {\n    return {\n      persistedSettings: getPersisedSettingsFromFile(),\n    };\n  }\n}\n"],"names":[],"mappings":"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","debug_id":"625442b7-4189-5173-9439-ed71cebc322e"}