{"version":3,"file":"index.js","sources":["app/index.ts"],"sourceRoot":"/","sourcesContent":["import { app, protocol, session, shell, dialog } from 'electron';\nimport { readFile } from 'fs';\nimport path from 'path';\nimport isDev from 'electron-is-dev';\nimport { setupAutoUpdates } from '../updates';\nimport { InMemoryStore } from '../store';\nimport { WindowManager } from './window';\nimport { store } from '../settings/main/store';\nimport {\n  ALTAIR_CUSTOM_PROTOCOL,\n  IPC_EVENT_NAMES,\n} from '@altairgraphql/electron-interop';\nimport { error, log } from '../utils/log';\nimport { findCustomProtocolUrlInArgv } from '../utils';\n\nexport class ElectronApp {\n  store: InMemoryStore;\n  windowManager: WindowManager;\n\n  constructor() {\n    this.store = new InMemoryStore();\n    this.windowManager = new WindowManager(this);\n\n    const gotTheLock = app.requestSingleInstanceLock();\n    if (!gotTheLock) {\n      log('An instance already exists.');\n      app.quit();\n      return process.exit(0);\n    }\n\n    // https://www.electronjs.org/docs/latest/tutorial/launch-app-from-url-in-another-app\n    if (process.defaultApp) {\n      if (process.argv.length >= 2) {\n        app.setAsDefaultProtocolClient(ALTAIR_CUSTOM_PROTOCOL, process.execPath, [\n          path.resolve(process.argv[1] ?? ''),\n        ]);\n      }\n    } else {\n      app.setAsDefaultProtocolClient(ALTAIR_CUSTOM_PROTOCOL);\n    }\n\n    protocol.registerSchemesAsPrivileged([\n      {\n        scheme: ALTAIR_CUSTOM_PROTOCOL,\n        privileges: {\n          standard: true,\n          secure: true,\n          corsEnabled: true,\n          supportFetchAPI: true,\n        },\n      },\n    ]);\n\n    this.manageEvents();\n  }\n\n  async manageEvents() {\n    // This method will be called when Electron has finished\n    // initialization and is ready to create browser windows.\n    // Some APIs can only be used after this event occurs.\n    app.whenReady().then(async () => {\n      const settings = store.get('settings');\n      log(settings);\n      if (settings) {\n        /**\n         * @type Electron.Config\n         */\n        const proxyConfig: Electron.ProxyConfig = {\n          mode: 'direct',\n        };\n\n        switch (settings.proxy_setting) {\n          case 'none':\n            proxyConfig.mode = 'direct';\n            break;\n          case 'autodetect':\n            proxyConfig.mode = 'auto_detect';\n            break;\n          case 'system':\n            proxyConfig.mode = 'system';\n            break;\n          case 'pac':\n            proxyConfig.mode = 'pac_script';\n            proxyConfig.pacScript = settings.pac_address;\n            break;\n          case 'proxy_server':\n            proxyConfig.mode = 'fixed_servers';\n            proxyConfig.proxyRules = `${settings.proxy_host}:${settings.proxy_port}`;\n            break;\n          default:\n        }\n        await session.defaultSession.setProxy(proxyConfig);\n        const proxy = await session.defaultSession.resolveProxy('http://localhost');\n        log(proxy, proxyConfig);\n      }\n      try {\n        await this.windowManager.createWindow();\n      } catch (err) {\n        log('Error creating window', err);\n        dialog.showErrorBox(\n          'Error creating window. Do you know what the issue is? Feel free to create a github issue',\n          err as string\n        );\n        throw err;\n      }\n\n      if (!isDev) {\n        setupAutoUpdates();\n      }\n    });\n\n    // Quit when all windows are closed.\n    app.on('window-all-closed', () => {\n      // On macOS it is common for applications and their menu bar\n      // to stay active until the user quits explicitly with Cmd + Q\n      if (process.platform !== 'darwin') {\n        app.quit();\n      }\n    });\n\n    app.on('activate', () => {\n      if (!this.windowManager) {\n        throw new Error('App not started');\n      }\n      // On macOS it's common to re-create a window in the app when the\n      // dock icon is clicked and there are no other windows open.\n      if (!this.windowManager.getInstance()) {\n        this.windowManager.createWindow();\n      }\n    });\n\n    // Handle the protocol. In this case, we choose to show an Error Box.\n    app.on('open-url', (event, url) => {\n      this.handleOpenUrlEvent(url);\n    });\n    app.on('second-instance', (event, argv) => {\n      // Someone tried to run a second instance, we should focus our window.\n      const windowInstance = this.windowManager.getInstance();\n      if (windowInstance) {\n        if (windowInstance.isMinimized()) {\n          windowInstance.restore();\n        }\n        windowInstance.focus();\n      }\n      const url = findCustomProtocolUrlInArgv(argv);\n      if (url) {\n        this.handleOpenUrlEvent(url);\n      }\n    });\n\n    app.on('will-finish-launching', () => {\n      app.on('open-file', (ev, path) => {\n        readFile(path, 'utf8', (err, data) => {\n          if (err) {\n            return;\n          }\n          this.windowManager.sendMessage(IPC_EVENT_NAMES.FILE_OPENED, data);\n        });\n      });\n    });\n\n    app.on(\n      'certificate-error',\n      (event, webContents, url, error, certificate, callback) => {\n        event.preventDefault();\n        // Inform user of invalid certificate\n        webContents.send('certificate-error', error);\n        dialog\n          .showMessageBox({\n            type: 'question',\n            title: 'Invalid Certificate',\n            message: `You are making a request with an invalid certificate. Do you want to continue? (URL: ${url}, Issuer: ${certificate.issuerName}, Subject: ${certificate.subjectName}, Error: ${error})`,\n            buttons: ['Yes', 'No'],\n          })\n          .then((result) => {\n            if (result.response === 0) {\n              callback(true);\n            } else {\n              callback(false);\n            }\n          });\n      }\n    );\n\n    app.on('web-contents-created', (event, contents) => {\n      contents.setWindowOpenHandler((details) => {\n        try {\n          log('Opening url', details.url);\n          // Ask the operating system to open this event's url in the default browser.\n          const url = new URL(details.url);\n          const supportedProtocols = ['http:', 'https:', 'mailto:'];\n          if (!supportedProtocols.includes(url.protocol)) {\n            log('Unsupported protocol', url.protocol);\n            return { action: 'deny' };\n          }\n\n          // Allow popups to be opened in the app\n          if (details.features.includes('popup')) {\n            // session cache should be cleared for popup windows\n            return {\n              action: 'allow',\n              overrideBrowserWindowOptions: {\n                webPreferences: {\n                  partition: 'popup',\n                },\n              },\n            };\n          }\n          shell.openExternal(url.href);\n        } catch (err) {\n          log('Error opening url', err);\n        }\n        return { action: 'deny' };\n      });\n    });\n\n    app.on('render-process-gone', (event, webContents, details) => {\n      error('Render process gone', details);\n    });\n\n    app.on('child-process-gone', (event, details) => {\n      error('Child process gone', details);\n    });\n  }\n\n  private handleOpenUrlEvent(url: string) {\n    log('App opened from url', url);\n\n    this.windowManager.sendMessage(IPC_EVENT_NAMES.URL_OPENED, url);\n  }\n}\n"],"names":[],"mappings":";;;;;;;;AAAA,uCAAiE;AACjE,2BAA8B;AAC9B,gDAAwB;AACxB,sEAAoC;AACpC,wCAA8C;AAC9C,oCAAyC;AACzC,qCAAyC;AACzC,kDAA+C;AAC/C,sEAGyC;AACzC,sCAA0C;AAC1C,oCAAuD;AAEvD,MAAa,WAAW;IAItB;QACE,IAAI,CAAC,KAAK,GAAG,IAAI,qBAAa,EAAE,CAAC;QACjC,IAAI,CAAC,aAAa,GAAG,IAAI,sBAAa,CAAC,IAAI,CAAC,CAAC;QAE7C,MAAM,UAAU,GAAG,cAAG,CAAC,yBAAyB,EAAE,CAAC;QACnD,IAAI,CAAC,UAAU,EAAE,CAAC;YAChB,IAAA,SAAG,EAAC,6BAA6B,CAAC,CAAC;YACnC,cAAG,CAAC,IAAI,EAAE,CAAC;YACX,OAAO,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QACzB,CAAC;QAED,qFAAqF;QACrF,IAAI,OAAO,CAAC,UAAU,EAAE,CAAC;YACvB,IAAI,OAAO,CAAC,IAAI,CAAC,MAAM,IAAI,CAAC,EAAE,CAAC;gBAC7B,cAAG,CAAC,0BAA0B,CAAC,yCAAsB,EAAE,OAAO,CAAC,QAAQ,EAAE;oBACvE,cAAI,CAAC,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC;iBACpC,CAAC,CAAC;YACL,CAAC;QACH,CAAC;aAAM,CAAC;YACN,cAAG,CAAC,0BAA0B,CAAC,yCAAsB,CAAC,CAAC;QACzD,CAAC;QAED,mBAAQ,CAAC,2BAA2B,CAAC;YACnC;gBACE,MAAM,EAAE,yCAAsB;gBAC9B,UAAU,EAAE;oBACV,QAAQ,EAAE,IAAI;oBACd,MAAM,EAAE,IAAI;oBACZ,WAAW,EAAE,IAAI;oBACjB,eAAe,EAAE,IAAI;iBACtB;aACF;SACF,CAAC,CAAC;QAEH,IAAI,CAAC,YAAY,EAAE,CAAC;IACtB,CAAC;IAED,KAAK,CAAC,YAAY;QAChB,wDAAwD;QACxD,yDAAyD;QACzD,sDAAsD;QACtD,cAAG,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,KAAK,IAAI,EAAE;YAC9B,MAAM,QAAQ,GAAG,aAAK,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;YACvC,IAAA,SAAG,EAAC,QAAQ,CAAC,CAAC;YACd,IAAI,QAAQ,EAAE,CAAC;gBACb;;mBAEG;gBACH,MAAM,WAAW,GAAyB;oBACxC,IAAI,EAAE,QAAQ;iBACf,CAAC;gBAEF,QAAQ,QAAQ,CAAC,aAAa,EAAE,CAAC;oBAC/B,KAAK,MAAM;wBACT,WAAW,CAAC,IAAI,GAAG,QAAQ,CAAC;wBAC5B,MAAM;oBACR,KAAK,YAAY;wBACf,WAAW,CAAC,IAAI,GAAG,aAAa,CAAC;wBACjC,MAAM;oBACR,KAAK,QAAQ;wBACX,WAAW,CAAC,IAAI,GAAG,QAAQ,CAAC;wBAC5B,MAAM;oBACR,KAAK,KAAK;wBACR,WAAW,CAAC,IAAI,GAAG,YAAY,CAAC;wBAChC,WAAW,CAAC,SAAS,GAAG,QAAQ,CAAC,WAAW,CAAC;wBAC7C,MAAM;oBACR,KAAK,cAAc;wBACjB,WAAW,CAAC,IAAI,GAAG,eAAe,CAAC;wBACnC,WAAW,CAAC,UAAU,GAAG,GAAG,QAAQ,CAAC,UAAU,IAAI,QAAQ,CAAC,UAAU,EAAE,CAAC;wBACzE,MAAM;oBACR,QAAQ;gBACV,CAAC;gBACD,MAAM,kBAAO,CAAC,cAAc,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC;gBACnD,MAAM,KAAK,GAAG,MAAM,kBAAO,CAAC,cAAc,CAAC,YAAY,CAAC,kBAAkB,CAAC,CAAC;gBAC5E,IAAA,SAAG,EAAC,KAAK,EAAE,WAAW,CAAC,CAAC;YAC1B,CAAC;YACD,IAAI,CAAC;gBACH,MAAM,IAAI,CAAC,aAAa,CAAC,YAAY,EAAE,CAAC;YAC1C,CAAC;YAAC,OAAO,GAAG,EAAE,CAAC;gBACb,IAAA,SAAG,EAAC,uBAAuB,EAAE,GAAG,CAAC,CAAC;gBAClC,iBAAM,CAAC,YAAY,CACjB,0FAA0F,EAC1F,GAAa,CACd,CAAC;gBACF,MAAM,GAAG,CAAC;YACZ,CAAC;YAED,IAAI,CAAC,yBAAK,EAAE,CAAC;gBACX,IAAA,0BAAgB,GAAE,CAAC;YACrB,CAAC;QACH,CAAC,CAAC,CAAC;QAEH,oCAAoC;QACpC,cAAG,CAAC,EAAE,CAAC,mBAAmB,EAAE,GAAG,EAAE;YAC/B,4DAA4D;YAC5D,8DAA8D;YAC9D,IAAI,OAAO,CAAC,QAAQ,KAAK,QAAQ,EAAE,CAAC;gBAClC,cAAG,CAAC,IAAI,EAAE,CAAC;YACb,CAAC;QACH,CAAC,CAAC,CAAC;QAEH,cAAG,CAAC,EAAE,CAAC,UAAU,EAAE,GAAG,EAAE;YACtB,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE,CAAC;gBACxB,MAAM,IAAI,KAAK,CAAC,iBAAiB,CAAC,CAAC;YACrC,CAAC;YACD,iEAAiE;YACjE,4DAA4D;YAC5D,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,WAAW,EAAE,EAAE,CAAC;gBACtC,IAAI,CAAC,aAAa,CAAC,YAAY,EAAE,CAAC;YACpC,CAAC;QACH,CAAC,CAAC,CAAC;QAEH,qEAAqE;QACrE,cAAG,CAAC,EAAE,CAAC,UAAU,EAAE,CAAC,KAAK,EAAE,GAAG,EAAE,EAAE;YAChC,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,CAAC;QAC/B,CAAC,CAAC,CAAC;QACH,cAAG,CAAC,EAAE,CAAC,iBAAiB,EAAE,CAAC,KAAK,EAAE,IAAI,EAAE,EAAE;YACxC,sEAAsE;YACtE,MAAM,cAAc,GAAG,IAAI,CAAC,aAAa,CAAC,WAAW,EAAE,CAAC;YACxD,IAAI,cAAc,EAAE,CAAC;gBACnB,IAAI,cAAc,CAAC,WAAW,EAAE,EAAE,CAAC;oBACjC,cAAc,CAAC,OAAO,EAAE,CAAC;gBAC3B,CAAC;gBACD,cAAc,CAAC,KAAK,EAAE,CAAC;YACzB,CAAC;YACD,MAAM,GAAG,GAAG,IAAA,mCAA2B,EAAC,IAAI,CAAC,CAAC;YAC9C,IAAI,GAAG,EAAE,CAAC;gBACR,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,CAAC;YAC/B,CAAC;QACH,CAAC,CAAC,CAAC;QAEH,cAAG,CAAC,EAAE,CAAC,uBAAuB,EAAE,GAAG,EAAE;YACnC,cAAG,CAAC,EAAE,CAAC,WAAW,EAAE,CAAC,EAAE,EAAE,IAAI,EAAE,EAAE;gBAC/B,IAAA,aAAQ,EAAC,IAAI,EAAE,MAAM,EAAE,CAAC,GAAG,EAAE,IAAI,EAAE,EAAE;oBACnC,IAAI,GAAG,EAAE,CAAC;wBACR,OAAO;oBACT,CAAC;oBACD,IAAI,CAAC,aAAa,CAAC,WAAW,CAAC,kCAAe,CAAC,WAAW,EAAE,IAAI,CAAC,CAAC;gBACpE,CAAC,CAAC,CAAC;YACL,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,cAAG,CAAC,EAAE,CACJ,mBAAmB,EACnB,CAAC,KAAK,EAAE,WAAW,EAAE,GAAG,EAAE,KAAK,EAAE,WAAW,EAAE,QAAQ,EAAE,EAAE;YACxD,KAAK,CAAC,cAAc,EAAE,CAAC;YACvB,qCAAqC;YACrC,WAAW,CAAC,IAAI,CAAC,mBAAmB,EAAE,KAAK,CAAC,CAAC;YAC7C,iBAAM;iBACH,cAAc,CAAC;gBACd,IAAI,EAAE,UAAU;gBAChB,KAAK,EAAE,qBAAqB;gBAC5B,OAAO,EAAE,wFAAwF,GAAG,aAAa,WAAW,CAAC,UAAU,cAAc,WAAW,CAAC,WAAW,YAAY,KAAK,GAAG;gBAChM,OAAO,EAAE,CAAC,KAAK,EAAE,IAAI,CAAC;aACvB,CAAC;iBACD,IAAI,CAAC,CAAC,MAAM,EAAE,EAAE;gBACf,IAAI,MAAM,CAAC,QAAQ,KAAK,CAAC,EAAE,CAAC;oBAC1B,QAAQ,CAAC,IAAI,CAAC,CAAC;gBACjB,CAAC;qBAAM,CAAC;oBACN,QAAQ,CAAC,KAAK,CAAC,CAAC;gBAClB,CAAC;YACH,CAAC,CAAC,CAAC;QACP,CAAC,CACF,CAAC;QAEF,cAAG,CAAC,EAAE,CAAC,sBAAsB,EAAE,CAAC,KAAK,EAAE,QAAQ,EAAE,EAAE;YACjD,QAAQ,CAAC,oBAAoB,CAAC,CAAC,OAAO,EAAE,EAAE;gBACxC,IAAI,CAAC;oBACH,IAAA,SAAG,EAAC,aAAa,EAAE,OAAO,CAAC,GAAG,CAAC,CAAC;oBAChC,4EAA4E;oBAC5E,MAAM,GAAG,GAAG,IAAI,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;oBACjC,MAAM,kBAAkB,GAAG,CAAC,OAAO,EAAE,QAAQ,EAAE,SAAS,CAAC,CAAC;oBAC1D,IAAI,CAAC,kBAAkB,CAAC,QAAQ,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE,CAAC;wBAC/C,IAAA,SAAG,EAAC,sBAAsB,EAAE,GAAG,CAAC,QAAQ,CAAC,CAAC;wBAC1C,OAAO,EAAE,MAAM,EAAE,MAAM,EAAE,CAAC;oBAC5B,CAAC;oBAED,uCAAuC;oBACvC,IAAI,OAAO,CAAC,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,EAAE,CAAC;wBACvC,oDAAoD;wBACpD,OAAO;4BACL,MAAM,EAAE,OAAO;4BACf,4BAA4B,EAAE;gCAC5B,cAAc,EAAE;oCACd,SAAS,EAAE,OAAO;iCACnB;6BACF;yBACF,CAAC;oBACJ,CAAC;oBACD,gBAAK,CAAC,YAAY,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;gBAC/B,CAAC;gBAAC,OAAO,GAAG,EAAE,CAAC;oBACb,IAAA,SAAG,EAAC,mBAAmB,EAAE,GAAG,CAAC,CAAC;gBAChC,CAAC;gBACD,OAAO,EAAE,MAAM,EAAE,MAAM,EAAE,CAAC;YAC5B,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,cAAG,CAAC,EAAE,CAAC,qBAAqB,EAAE,CAAC,KAAK,EAAE,WAAW,EAAE,OAAO,EAAE,EAAE;YAC5D,IAAA,WAAK,EAAC,qBAAqB,EAAE,OAAO,CAAC,CAAC;QACxC,CAAC,CAAC,CAAC;QAEH,cAAG,CAAC,EAAE,CAAC,oBAAoB,EAAE,CAAC,KAAK,EAAE,OAAO,EAAE,EAAE;YAC9C,IAAA,WAAK,EAAC,oBAAoB,EAAE,OAAO,CAAC,CAAC;QACvC,CAAC,CAAC,CAAC;IACL,CAAC;IAEO,kBAAkB,CAAC,GAAW;QACpC,IAAA,SAAG,EAAC,qBAAqB,EAAE,GAAG,CAAC,CAAC;QAEhC,IAAI,CAAC,aAAa,CAAC,WAAW,CAAC,kCAAe,CAAC,UAAU,EAAE,GAAG,CAAC,CAAC;IAClE,CAAC;CACF;AAvND,kCAuNC","debug_id":"75178f76-97b0-54d7-b617-afd32721c7b2"}