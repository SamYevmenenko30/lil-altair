{"version":3,"file":"index.js","sources":["auth/server/index.ts"],"sourceRoot":"/","sourcesContent":["import { Server } from 'http';\nimport express from 'express';\nimport bodyParser from 'body-parser';\nimport { EventEmitter } from 'events';\nimport path from 'path';\nimport { randomBytes } from 'crypto';\nimport { getStaticDirectory } from '../../utils';\nimport { session, shell } from 'electron';\nimport { getCSP, INLINE, SELF } from 'csp-header';\nimport getPort from 'get-port';\n\nexport const IPC_SET_CUSTOM_TOKEN_EVENT = 'auth:set-custom-token';\n\nconst newNonce = () => {\n  const validChars =\n    'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n  const array = randomBytes(40).map(x =>\n    validChars.charCodeAt(x % validChars.length)\n  );\n  return String.fromCharCode(...array);\n};\nconst authClientStaticDirectory = () =>\n  path.resolve(require.resolve('@altairgraphql/login-redirect'), '..', 'dist');\n\nexport class AuthServer {\n  private port = 3000; // default port. Might be different at runtime.\n  private server?: Server;\n  private sessionPartition = 'persist:auth';\n  private nonce = newNonce();\n  private emitter = new EventEmitter();\n  private ttlSeconds = 10 * 60; // 10m\n\n  async start() {\n    const app = express();\n    app.use(express.static(authClientStaticDirectory()));\n    app.use(bodyParser.json());\n\n    app.use('/login', (req, res) => {\n      return res.sendFile(\n        path.resolve(authClientStaticDirectory(), 'index.html')\n      );\n    });\n    app.use('/callback', (req, res) => {\n      // TODO: Verify ttl\n      if (req.body.nonce !== this.nonce) {\n        return res\n          .status(400)\n          .send({ status: 'error', message: 'invalid request' });\n      }\n\n      this.emitter.emit('token', req.body.token);\n      return res.send({ status: 'success' });\n    });\n\n    this.port = await this.getAvailablePort();\n    this.server = app.listen(this.port, () => {\n      // console.log(`auth server listening at port ${this.port}`);\n    });\n  }\n\n  terminate() {\n    this.emitter.removeAllListeners('token');\n    if (this.server) {\n      this.server.close();\n    }\n  }\n\n  async getCustomToken() {\n    if (!this.server) {\n      await this.start();\n    }\n    // TODO: Use a hosted domain instead\n    await shell.openExternal(\n      `http://localhost:${this.port}/login?nonce=${this.nonce}`\n    );\n\n    const token = await this.listenForToken();\n\n    this.terminate();\n\n    return token;\n  }\n\n  private listenForToken() {\n    return new Promise<string>((resolve, reject) => {\n      this.emitter.once('token', (token: string) => {\n        if (!token) {\n          return reject(new Error('Could not get token'));\n        }\n        return resolve(token);\n      });\n    });\n  }\n\n  private getSession() {\n    const authSession = session.fromPartition(this.sessionPartition);\n    authSession.webRequest.onHeadersReceived((details, callback) => {\n      callback({\n        responseHeaders: {\n          ...details.responseHeaders,\n          'Content-Security-Policy': [\n            getCSP({\n              directives: {\n                // \"default-src\": [\"none\"],\n                'script-src': [\n                  SELF,\n                  INLINE,\n                  'strict-dynamic',\n                  'https://www.gstatic.com',\n                  'https://apis.google.com',\n                ],\n              },\n            }),\n          ],\n        },\n      });\n    });\n\n    return authSession;\n  }\n\n  private async getAvailablePort() {\n    return getPort({ port: this.port });\n  }\n}\n"],"names":[],"mappings":"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","debug_id":"42cd270a-319a-52c3-8665-99dede3cd18d"}